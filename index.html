<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Materialbestellung</title>

  <style>
    :root {
      /* Militärischer Look */
      --shell-bg: #cfd3b8;
      --shell-border: #89906f;
      --shell-shadow: rgba(0,0,0,0.18);
      --header-bg: #3b4b2f;
      --header-text: #fdfdf8;
      --stepbar-bg: #66784a;
      --stepbar-text: #fdfdf8;

      --field-bg: #f4f2dd;
      --field-border: #a5aa8b;
      --field-border-focus: #6f7c55;

      --text-main: #141515;
      --text-muted: #4e5440;
      --error: #b02020;
      --btn-main: #2f4f39;
      --btn-main-text: #ffffff;
      --btn-secondary-bg: #dde1c7;
      --btn-secondary-text: #222;
      --step-inactive: #aeb49b;
      --step-active: #2f4f39;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 12px;
      background: radial-gradient(circle at top, #9ea586 0, #565c46 55%, #282d22 100%);
      color: var(--text-main);
    }

    .shell {
      max-width: 760px;
      margin: 0 auto;
      background: var(--shell-bg);
      border-radius: 14px;
      border: 1px solid var(--shell-border);
      box-shadow: 0 12px 26px var(--shell-shadow);
      overflow: hidden;
    }

    .app-inner {
      padding: 0 14px 18px;
    }

    /* Kopfzeile */
    h1 {
      margin: 0;
      padding: 10px 16px;
      background: var(--header-bg);
      color: var(--header-text);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.3rem;
      letter-spacing: 0.03em;
    }
    h1 span.version {
      font-size: 0.8rem;
      opacity: 0.9;
      font-weight: 500;
    }

    /* Step-Balken */
    .step-indicator {
      display: flex;
      gap: 4px;
      padding: 6px 16px 8px;
      background: #b9bea0;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .step-dot {
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: var(--step-inactive);
    }
    .step-dot.active {
      background: var(--step-active);
    }

    .card {
      margin-top: 14px;
      background: transparent;
    }
    .card-header {
      margin: 0 -14px 8px;
      padding: 8px 16px;
      background: var(--stepbar-bg);
      color: var(--stepbar-text);
      font-size: 1.05rem;
      font-weight: 600;
    }

    h3 {
      font-size: 0.92rem;
      margin: 12px 0 4px;
      font-weight: 600;
    }

    p.rules {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin: 6px 0 4px;
      line-height: 1.4;
    }

    label {
      display:block;
      font-size:0.78rem;
      margin-bottom:3px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
    }

    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--field-border);
      font-size: 0.96rem;
      box-sizing: border-box;
      background: var(--field-bg);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--field-border-focus);
      box-shadow: 0 0 0 1px var(--field-border-focus);
    }

    input[readonly] {
      opacity: 0.9;
      background: #ece9d4;
    }

    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--field-border);
      font-size: 0.96rem;
      box-sizing: border-box;
      background: var(--field-bg);
      resize: vertical;
      min-height: 70px;
    }

    .field {
      margin-top: 8px;
    }

    .button-row {
      display:flex;
      gap:8px;
      margin-top:14px;
    }

    button {
      flex:1;
      padding:10px 14px;
      border-radius:999px;
      border:none;
      font-size:0.95rem;
      cursor:pointer;
      font-weight:500;
    }

    button.primary {
      background: var(--btn-main);
      color:var(--btn-main-text);
    }
    button.primary:hover { filter: brightness(1.05); }

    button.secondary {
      background: var(--btn-secondary-bg);
      color:var(--btn-secondary-text);
    }
    button.secondary:hover { filter: brightness(0.97); }

    .error {
      color: var(--error);
      font-size:0.8rem;
      margin-top:4px;
      white-space:pre-wrap;
    }

    /* Kategorien / Materialliste */
    .category {
      border-top:1px solid rgba(0,0,0,0.12);
      padding-top:10px;
      margin-top:10px;
    }

    .category-header {
      display:flex;
      justify-content:space-between;
      cursor:pointer;
      align-items:center;
    }

    .category-title {
      font-weight:600;
      font-size:0.9rem;
    }

    .subcategories {
      margin-top:6px;
      display:none;
    }

    .subcategories.open {
      display:block;
    }

    .qty-row {
      display:grid;
      grid-template-columns: 3fr 0.9fr;
      gap:8px;
      margin-bottom:4px;
      align-items:center;
    }

    .qty-row span {
      font-size:0.85rem;
    }

    .qty-row input[type="number"] {
      width:100%;
      text-align:right;
    }

    ul.summary {
      padding-left:18px;
      margin-top:4px;
    }
    ul.summary > li {
      margin-bottom:4px;
    }

    @media (max-width:600px) {
      body { padding: 8px; }
      h1 { font-size: 1.05rem; flex-wrap: wrap; row-gap: 4px; }
      h1 span.version { margin-left:auto; }
    }
  </style>

  <!-- EmailJS: direktes Versenden -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    const EMAILJS_SERVICE_ID  = "service_qwz9qbt";
    const EMAILJS_TEMPLATE_ID = "template_i6hs68v";
    const EMAILJS_PUBLIC_KEY  = "ea8CHyfL3ZcO48AfE";
    (function() { emailjs.init(EMAILJS_PUBLIC_KEY); })();
  </script>
</head>
<body>
  <div class="shell">
    <h1>
      Flt Bttr FFZ – Materialbestellung
      <span class="version">1.2</span>
    </h1>

    <div class="step-indicator">
      <div class="step-dot active" data-step="1"></div>
      <div class="step-dot" data-step="2"></div>
      <div class="step-dot" data-step="3"></div>
    </div>

    <div class="app-inner">
      <!-- LOGIN -->
      <div id="loginCard" class="card">
        <div class="card-header">Anmeldung</div>
        <p class="rules">
          Diese Seite ist geschützt. Bitte Passwort eingeben.
        </p>
        <div class="field">
          <label for="pwInput">Passwort</label>
          <input id="pwInput" type="password" autocomplete="current-password">
        </div>
        <div id="loginError" class="error"></div>
        <div class="button-row">
          <button class="primary" onclick="handleLogin()">Login</button>
        </div>
        <p style="font-size:0.75rem;color:#555;margin-top:10px;">
          Hinweis: Das Passwort wird im Browser als SHA-256-Hash geprüft, nicht im Klartext gespeichert.
        </p>
      </div>

      <!-- APP -->
      <div id="appCard" style="display:none;">
        <!-- STEP 1 -->
        <div id="step1" class="card">
          <div class="card-header">1. Grunddaten / Données de base</div>

          <p class="rules">
            <strong>Regeln / Règles:</strong><br>
            – Bestellungen, Abholung und Rückgabe nur Montag–Freitag.<br>
            – Abholung mindestens 25 h nach Bestelldatum (Zeitpunkt der Freigabe).<br>
            – Abholung am Montag nur möglich, wenn Bestellung bis Donnerstag 17:00 der Vorwoche erfolgt ist.
          </p>

          <h3>Personalien</h3>
          <div class="field">
            <label for="language">Sprache / Langue</label>
            <select id="language">
              <option value="">Bitte wählen / Veuillez choisir</option>
              <option value="de">Deutsch</option>
              <option value="fr">Français</option>
            </select>
          </div>

          <div class="field">
            <label for="besteller">Besteller / Demandeur</label>
            <input id="besteller" type="text" placeholder="Name / Nom, Funktion / Fonction">
          </div>

          <div class="field">
            <label for="zug">Zug / Section</label>
            <select id="zug">
              <option value="">Bitte wählen / Veuillez choisir</option>
              <option value="C1">C1</option>
              <option value="M113">M113</option>
              <option value="KDO">KDO</option>
              <option value="UEM 1">UEM 1</option>
              <option value="UEM 2">UEM 2</option>
              <option value="WETTER">WETTER</option>
            </select>
          </div>

          <h3>Zeitliche Vorgaben</h3>
          <div class="field">
            <label for="bestelldatum">
              Bestelldatum &amp; Zeit / Date et heure de la demande (wird automatisch gesetzt)
            </label>
            <input id="bestelldatum" type="datetime-local" readonly>
          </div>

          <div class="field">
            <label for="abholung">Abholung (Mo–Fr, min. +25 h) / Retrait (lu–ve, min. +25 h)</label>
            <input id="abholung" type="datetime-local">
          </div>

          <div class="field">
            <label for="rueckgabe">Rückgabe (Mo–Fr) / Retour (lu–ve)</label>
            <input id="rueckgabe" type="datetime-local">
          </div>

          <div id="step1Error" class="error"></div>
          <div class="button-row">
            <button class="primary" onclick="nextStep1()">Weiter / Suivant</button>
          </div>
        </div>

        <!-- STEP 2 -->
        <div id="step2" class="card" style="display:none;">
          <div class="card-header" id="step2Title">2. Material</div>
          <p id="step2Intro" class="rules">
            Wähle die benötigten Materialkategorien und gib die Menge an.
          </p>
          <div id="categories"></div>
          <div id="step2Error" class="error"></div>
          <div class="button-row">
            <button class="secondary" onclick="goToStep(1)">Zurück / Retour</button>
            <button class="primary" onclick="nextStep2()">Weiter / Suivant</button>
          </div>
        </div>

        <!-- STEP 3 -->
        <div id="step3" class="card" style="display:none;">
          <div class="card-header" id="step3Title">3. Zusammenfassung / Récapitulatif</div>
          <div id="summaryContent"></div>

          <div class="field" style="margin-top:12px;">
            <label for="remarks">Bemerkungen / Remarques</label>
            <textarea id="remarks" rows="3"
              placeholder="Zusätzliche Informationen / Informations complémentaires"></textarea>
          </div>

          <div class="button-row">
            <button class="secondary" onclick="goToStep(2)">Zurück / Retour</button>
            <button class="primary" onclick="sendOrder()">Senden / Envoyer</button>
          </div>
          <div id="sendInfo" class="error" style="color:#060;"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ===== Passwort-Logik (Variante B: gehashter Vergleich) =====
  const PASSWORD_HASH = "d8b1390eb24e12b5dac0cc98cc9fa5cbc12bfffb9e0659172a5a3296ef8f1f4e";

  async function sha256(str) {
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function handleLogin() {
    const pwInput = document.getElementById("pwInput");
    const errorEl = document.getElementById("loginError");
    errorEl.textContent = "";
    const value = pwInput.value;
    if (!value) {
      errorEl.textContent = "Bitte Passwort eingeben.";
      return;
    }
    try {
      const hash = await sha256(value);
      if (hash === PASSWORD_HASH) {
        document.getElementById("loginCard").style.display = "none";
        document.getElementById("appCard").style.display = "block";
      } else {
        errorEl.textContent = "Passwort falsch.";
      }
    } catch (e) {
      errorEl.textContent = "Browser unterstützt die Sicherheitsfunktion nicht.";
    }
  }

  // ===== App-Logik =====
  const categories = [
  {
    "key": "stgw_90",
    "label": {
      "de": "Stgw 90",
      "fr": "Fass 90"
    },
    "subs": [
      {
        "key": "standard_kd_box_1x_schiessfahne_komplett_1x_magazintasche_5x_ausschusszelt",
        "label": {
          "de": "Standard KD-Box: 1x Schiessfahne komplett, 1x Magazintasche, 5x Ausschusszelt",
          "fr": "Box courte distance standard: 1x drapeau de tir complet, 1x saccoche magazin, 5x toiles de rebut"
        }
      },
      {
        "key": "standard_gef_s_2x_schiessfahne_komplett_2x_magazintasche_1x_rak_pist_10x_ausschusszelt_3x_l_rmsprechgarnituren_komplett_3x_se_135_komplett_1x_anp_1x_fg_235_1x_sanit_tsbahre_1x_wolldecke_1x_verbandsmaterial_6x_aa_batterien",
        "label": {
          "de": "Standard Gef S (2x Schiessfahne komplett, 2x Magazintasche, 1x Rak-Pist, 10x Ausschusszelt, 3x Lärmsprechgarnituren komplett, 3x SE-135 komplett, 1x ANP, 1x FG-235, 1x Sanitätsbahre, 1x Wolldecke, 1x Verbandsmaterial, 6x AA Batterien",
          "fr": "Tir de combat standard: 2x drapeau de tir, 2x saccoche magazin, 1x lance fusées, 10x toiles de rebut, 3x ganiture contre le bruit complet, 3x SE-135 complet,1x ANP, 1x FG-235,1x brancard sanitaire, 1x couverture de laine, 1x matériel de pensement, 6x batterie AA"
        }
      },
      {
        "key": "manipats_5_6mm",
        "label": {
          "de": "Manipats\n5.6mm",
          "fr": "Manipats\n5.6mm"
        }
      },
      {
        "key": "zugsparkdienstkiste",
        "label": {
          "de": "Zugsparkdienstkiste",
          "fr": "Caisse de service de parc"
        }
      },
      {
        "key": "magazintasche_18_st_ck",
        "label": {
          "de": "Magazintasche à 18 Stück",
          "fr": "Saccoche à magazin à 18 pièces"
        }
      }
    ]
  },
  {
    "key": "mg_64",
    "label": {
      "de": "MG 64",
      "fr": "Mitr 64"
    },
    "subs": [
      {
        "key": "mg_64_12_7mm_3_beinlaffette_lehren_und_reinigungsmaterial_2_verschl_sse",
        "label": {
          "de": "MG 64 12.7mm: 3-Beinlaffette, Lehren- und Reinigungsmaterial, 2 Verschlüsse",
          "fr": "Mitr 64 12.7mm: Affut 3-pied, jauges et matériel de nettoyage, 2 culasses"
        }
      },
      {
        "key": "manipats_12_7mm_kiste_100",
        "label": {
          "de": "Manipats 12.7mm (Kiste à 100)",
          "fr": "Manipats 12.7mm (caisse à 100)"
        }
      },
      {
        "key": "gurt_entgurtungsapparat",
        "label": {
          "de": "Gurt- entgurtungsapparat",
          "fr": "Appareil a garnir et a dégarnir"
        }
      }
    ]
  },
  {
    "key": "funk",
    "label": {
      "de": "Funk",
      "fr": "Radio"
    },
    "subs": [
      {
        "key": "se_235_tragbar_3x_akku_se_235_tragversion",
        "label": {
          "de": "SE-235 tragbar: 3x Akku, SE-235, Tragversion",
          "fr": "SE-235 portable: 3x accu, SE-235, cacolet"
        }
      },
      {
        "key": "se_135_3x_akku_se_135_1x_b_ndel_lang_1x_b_ndel_kurz_1x_tasche_1x_antenne",
        "label": {
          "de": "SE-135: 3x Akku, SE-135, 1x Bändel lang, 1x Bändel kurz, 1x Tasche, 1x Antenne",
          "fr": "SE-135 portable: 3x accu, SE-135, 1x bretelle longue, 1x bretelle courte, 1x saccoche, 1x antenne"
        }
      },
      {
        "key": "adressnetzplan_flt_bttr_blau",
        "label": {
          "de": "Adressnetzplan Flt Bttr (blau)",
          "fr": "Plan de reseaux Bttr DF (bleu)"
        }
      },
      {
        "key": "adressnetzplan_ffz_bttr_weiss",
        "label": {
          "de": "Adressnetzplan FFZ Bttr (weiss)",
          "fr": "Plan de reseaux Bttr CCF (blanc)"
        }
      },
      {
        "key": "fill_gun_se_x35",
        "label": {
          "de": "Fill-Gun SE-X35",
          "fr": "Fill-Gun SE-X35"
        }
      },
      {
        "key": "lautsprecher_tragbar",
        "label": {
          "de": "Lautsprecher tragbar",
          "fr": "Haut-parleur portable"
        }
      },
      {
        "key": "fernantenne_geroh_1x_antenne_1x_tasche_und_bobine",
        "label": {
          "de": "Fernantenne \"GEROH\": 1x Antenne, 1x Tasche und Bobine",
          "fr": "Antenne \"GEROH\": 1x antenne, 1x saccoche et bobine"
        }
      },
      {
        "key": "fernantenne_t_inkl_1x_tasche",
        "label": {
          "de": "Fernantenne \"t\" (inkl 1x Tasche)",
          "fr": "Antenne \"t\" (inclus 1x saccoche)"
        }
      },
      {
        "key": "feldtelefon_kiste_7_ftf_90_gabelstange_bobine_mit_fk80_bobine_leer_14x_aa_batterien",
        "label": {
          "de": "Feldtelefon: Kiste à 7 Ftf 90, Gabelstange, Bobine mit FK80, Bobine leer, 14x AA Batterien",
          "fr": "Téléphone de camp: caisse à 7 tc 90, perche à fourche, bobine avec cable 80, bobine vide, 14x batterie AA"
        }
      },
      {
        "key": "messger_t_t_02",
        "label": {
          "de": "Messgerät T-02",
          "fr": "Appareil de mésure T-02"
        }
      },
      {
        "key": "akkumulatorenladeger_t_algt_96",
        "label": {
          "de": "Akkumulatorenladegerät (ALGT-96)",
          "fr": "Chargeur d'accumulateur (ALGT-93)"
        }
      },
      {
        "key": "fba_235_inkl_1_bobine_feldkabel_gabelstange_1x_bautasche",
        "label": {
          "de": "FBA-235 (inkl 1 Bobine Feldkabel, Gabelstange, 1x Bautasche)",
          "fr": "FBA-235 (inclus 1 bobine cable de campagne, perche à fourche, 1x saccoche de construction)"
        }
      },
      {
        "key": "kabelverbindungszange",
        "label": {
          "de": "Kabelverbindungszange",
          "fr": "Pince à epissures"
        }
      },
      {
        "key": "bautasche",
        "label": {
          "de": "Bautasche",
          "fr": "Saccoche de construction"
        }
      },
      {
        "key": "linientasche",
        "label": {
          "de": "Linientasche",
          "fr": "Saccoche de ligne"
        }
      }
    ]
  },
  {
    "key": "sanit_tsdienst",
    "label": {
      "de": "Sanitätsdienst",
      "fr": "Service sanitaire"
    },
    "subs": [
      {
        "key": "sanit_tsbahre",
        "label": {
          "de": "Sanitätsbahre",
          "fr": "Brancard sanitaire"
        }
      },
      {
        "key": "verbandsmaterial",
        "label": {
          "de": "Verbandsmaterial",
          "fr": "Materiel de pensement"
        }
      },
      {
        "key": "hemostage_ausr_stung_1_kiste",
        "label": {
          "de": "Hemostage Ausrüstung (1 Kiste)",
          "fr": "Équipement hemostase (1 caisse)"
        }
      },
      {
        "key": "wolldecke",
        "label": {
          "de": "Wolldecke",
          "fr": "Couverture de laine"
        }
      }
    ]
  },
  {
    "key": "abc",
    "label": {
      "de": "ABC",
      "fr": "NBC"
    },
    "subs": [
      {
        "key": "reinigungsmaterial_zu_sm90",
        "label": {
          "de": "Reinigungsmaterial zu SM90",
          "fr": "Materiel de nettoyage pour MP90"
        }
      },
      {
        "key": "reinigungsmittel_1_flasche",
        "label": {
          "de": "Reinigungsmittel (1 flasche)",
          "fr": "Liquide de nettoyage (1 bouteille)"
        }
      }
    ]
  },
  {
    "key": "allgemein",
    "label": {
      "de": "Allgemein",
      "fr": "Général"
    },
    "subs": [
      {
        "key": "schlaghammer_5kg",
        "label": {
          "de": "Schlaghammer 5Kg",
          "fr": "Masse 5Kg"
        }
      },
      {
        "key": "locheisen",
        "label": {
          "de": "Locheisen",
          "fr": "Barre à mine"
        }
      },
      {
        "key": "pickel",
        "label": {
          "de": "Pickel",
          "fr": "Pioche"
        }
      },
      {
        "key": "schaufel",
        "label": {
          "de": "Schaufel",
          "fr": "Pelle"
        }
      },
      {
        "key": "markierungsfahne_set_6",
        "label": {
          "de": "Markierungsfahne (Set à 6)",
          "fr": "Fanions de marquage (set de 6)"
        }
      },
      {
        "key": "wassersack_inkl_innensack",
        "label": {
          "de": "Wassersack (inkl Innensack)",
          "fr": "Sac à eau (inclus sac intérieur)"
        }
      },
      {
        "key": "tarnnetz_gr_sse_je_nach_verf_gbarkeit",
        "label": {
          "de": "Tarnnetz (Grösse je nach Verfügbarkeit)",
          "fr": "Filet de camouflage (taille selon disponibilité)"
        }
      },
      {
        "key": "handschellen",
        "label": {
          "de": "Handschellen",
          "fr": "Menottes"
        }
      },
      {
        "key": "beil",
        "label": {
          "de": "Beil",
          "fr": "Hache"
        }
      },
      {
        "key": "nahkampsausr_stung_1x_sack_1x_kissen_1x_stock",
        "label": {
          "de": "Nahkampsausrüstung (1x Sack, 1x Kissen, 1x Stock)",
          "fr": "Moyens de contraine (1x saccoche, 1x coussin, 1x batôn)"
        }
      },
      {
        "key": "ausschusszelt",
        "label": {
          "de": "Ausschusszelt",
          "fr": "Toile de rebut"
        }
      },
      {
        "key": "sitometer",
        "label": {
          "de": "Sitometer",
          "fr": "Sitomètre"
        }
      },
      {
        "key": "bussole",
        "label": {
          "de": "Bussole",
          "fr": "Boussole"
        }
      },
      {
        "key": "kabelbinder",
        "label": {
          "de": "Kabelbinder",
          "fr": "Attaches jetables"
        }
      },
      {
        "key": "trassierband_gr_n",
        "label": {
          "de": "Trassierband grün",
          "fr": "Bande de minage vert"
        }
      },
      {
        "key": "trassierband_weiss",
        "label": {
          "de": "Trassierband weiss",
          "fr": "Bande de minage blanc"
        }
      },
      {
        "key": "trassierband_rot_weiss",
        "label": {
          "de": "Trassierband rot/weiss",
          "fr": "Bande de minage rouge/blanc"
        }
      }
    ]
  },
  {
    "key": "beobachten",
    "label": {
      "de": "Beobachten",
      "fr": "Observer"
    },
    "subs": [
      {
        "key": "feldstecher",
        "label": {
          "de": "Feldstecher",
          "fr": "Jumelles"
        }
      },
      {
        "key": "rlv_brille_in_kiste",
        "label": {
          "de": "RLV Brille in Kiste",
          "fr": "ILR lunettes dans caisse"
        }
      },
      {
        "key": "rlv_3x",
        "label": {
          "de": "RLV 3x",
          "fr": "ILR 3x"
        }
      },
      {
        "key": "rak_pistole_pistolet",
        "label": {
          "de": "Rak-Pistole\nPistolet",
          "fr": "Lancefusées"
        }
      }
    ]
  }
];

  const state = {
    language: "",
    besteller: "",
    zug: "",
    bestelldatum: "",
    abholung: "",
    rueckgabe: "",
    items: [],
    remarks: ""
  };

  function isWeekend(date) {
    const d = date.getDay();
    return d === 0 || d === 6;
  }
  function isMonday(date) { return date.getDay() === 1; }
  function pad(n) { return n<10?"0"+n:n; }
  function toLocalInputValue(date){
    return date.getFullYear()+"-"+pad(date.getMonth()+1)+"-"+pad(date.getDate())+
      "T"+pad(date.getHours())+":"+pad(date.getMinutes());
  }
  function mondayOrderDeadline(mondayDate){
    const d=new Date(mondayDate.getTime());
    d.setDate(d.getDate()-4);
    d.setHours(17,0,0,0);
    return d;
  }

  function initDates(){
    const now=new Date();
    const abholung=new Date(now.getTime()+26*3600*1000);
    const rueckgabe=new Date(now.getTime()+50*3600*1000);
    while(isWeekend(abholung)) abholung.setDate(abholung.getDate()+1);
    while(isWeekend(rueckgabe)) rueckgabe.setDate(rueckgabe.getDate()+1);
    abholungEl.value=toLocalInputValue(abholung);
    rueckgabeEl.value=toLocalInputValue(rueckgabe);
    bestelldatumEl.value = "";
  }

  function updateStepIndicator(step){
    document.querySelectorAll(".step-dot").forEach((el,idx)=>{
      if(idx<step) el.classList.add("active"); else el.classList.remove("active");
    });
  }
  function goToStep(step){
    step1.style.display=step===1?"block":"none";
    step2.style.display=step===2?"block":"none";
    step3.style.display=step===3?"block":"none";
    updateStepIndicator(step);
  }

  function nextStep1(){
    step1Error.textContent="";
    const language=languageEl.value;
    const best=besteller.value.trim();
    const zug=zugEl.value;
    const aVal=abholungEl.value;
    const rVal=rueckgabeEl.value;

    if(!language||!best||!zug||!aVal||!rVal){
      step1Error.textContent="Bitte Sprache, Besteller, Zug sowie Abholung und Rückgabe ausfüllen.";
      return;
    }

    const now = new Date();
    const b = now; // Bestelldatum = aktueller Zeitpunkt
    const a = new Date(aVal);
    const r = new Date(rVal);

    if(isWeekend(b)){
      step1Error.textContent="Keine Bestellungen Sa/So.";
      return;
    }
    if(isWeekend(a)||isWeekend(r)){
      step1Error.textContent="Abholung/Rückgabe nur Mo–Fr.";
      return;
    }
    if(a-b<25*3600*1000){
      step1Error.textContent="Abholung mind. +25 h nach Bestelldatum.";
      return;
    }
    if(r<a){
      step1Error.textContent="Rückgabe muss nach Abholung liegen.";
      return;
    }
    if(isMonday(a)){
      const deadline=mondayOrderDeadline(a);
      if(b>deadline){
        step1Error.textContent="Montag nur bestellbar bis Do 17:00 der Vorwoche.";
        return;
      }
    }

    state.language=language;
    state.besteller=best;
    state.zug=zug;
    state.bestelldatum=b.toISOString();
    state.abholung=aVal;
    state.rueckgabe=rVal;

    bestelldatumEl.value = toLocalInputValue(b);

    renderCategories();
    updateTextByLanguage();
    goToStep(2);
  }

  function getLang(){
    return state.language || languageEl.value || "de";
  }

  function renderCategories(){
    const lang=getLang();
    const container=document.getElementById("categories");
    container.innerHTML="";
    categories.forEach(cat=>{
      const catName=cat.label[lang]||cat.label.de;
      const wrapper=document.createElement("div");
      wrapper.className="category";
      wrapper.innerHTML=`
        <div class="category-header" onclick="toggleCategory('${cat.key}')">
          <div class="category-title">${catName}</div>
        </div>
        <div class="subcategories" id="subs-${cat.key}">
          ${cat.subs.map(sub=>{
            const name=sub.label[lang]||sub.label.de;
            return `<div class="qty-row">
              <span>${name}</span>
              <input type="number" min="0" step="1" value="0" id="subQty-${cat.key}-${sub.key}">
            </div>`;
          }).join("")}
        </div>
      `;
      container.appendChild(wrapper);
    });
  }

  function toggleCategory(key){
    const el=document.getElementById("subs-"+key);
    if(el) el.classList.toggle("open");
  }

  function nextStep2(){
    step2Error.textContent="";
    const lang=getLang();
    const items=[];
    categories.forEach(cat=>{
      const catItem={key:cat.key,subs:[]};
      cat.subs.forEach(sub=>{
        const el=document.getElementById("subQty-"+cat.key+"-"+sub.key);
        if(!el) return;
        const q=parseInt(el.value,10)||0;
        if(q>0) catItem.subs.push({key:sub.key,qty:q});
      });
      if(catItem.subs.length) items.push(catItem);
    });
    if(!items.length){
      step2Error.textContent=lang==="fr"
        ?"Veuillez sélectionner au moins une sous-catégorie avec une quantité."
        :"Bitte mindestens eine Unterkategorie mit Menge auswählen.";
      return;
    }
    state.items=items;
    buildSummary();
    goToStep(3);
  }

  function formatDateTime(val){
    if(!val) return "";
    const d=new Date(val);
    if(isNaN(d)) return val;
    return d.toLocaleString("de-CH");
  }

  function resolveLabelLang(catKey, subKey, lang){
    const cat=categories.find(c=>c.key===catKey);
    if(!cat) return {cat:catKey, sub:subKey||""};
    const catName=cat.label[lang] || cat.label.de;
    if(!subKey) return {cat:catName, sub:""};
    const sub=cat.subs.find(s=>s.key===subKey);
    const subName=sub ? (sub.label[lang] || sub.label.de) : subKey;
    return {cat:catName, sub:subName};
  }

  function resolveLabel(catKey, subKey){
    const lang=getLang();
    return resolveLabelLang(catKey, subKey, lang);
  }

  function updateTextByLanguage(){
    const lang=getLang();
    step2Title.textContent=lang==="fr"?"2. Matériel":"2. Material";
    step2Intro.textContent=lang==="fr"
      ?"Choisissez les catégories de matériel nécessaires et indiquez les quantités."
      :"Wähle die benötigten Materialkategorien und gib die Menge an.";
    step3Title.textContent=lang==="fr"?"3. Récapitulatif":"3. Zusammenfassung";
  }

  function buildSummary(){
    const lang=getLang();
    let html="";
    html+=`<p><strong>${lang==="fr"?"Demandeur":"Besteller"}:</strong> ${state.besteller}</p>`;
    html+=`<p><strong>${lang==="fr"?"Section":"Zug"}:</strong> ${state.zug}</p>`;
    html+=`<p><strong>${lang==="fr"?"Langue":"Sprache"}:</strong> ${lang==="fr"?"Français":"Deutsch"}</p>`;
    html+=`<p><strong>${lang==="fr"?"Date de la demande":"Bestelldatum"}:</strong> ${formatDateTime(state.bestelldatum)}</p>`;
    html+=`<p><strong>${lang==="fr"?"Retrait":"Abholung"}:</strong> ${formatDateTime(state.abholung)}</p>`;
    html+=`<p><strong>${lang==="fr"?"Retour":"Rückgabe"}:</strong> ${formatDateTime(state.rueckgabe)}</p>`;
    html+=`<h3>${lang==="fr"?"Matériel":"Material"}</h3>`;
    html+="<ul class='summary'>";
    state.items.forEach(item=>{
      const l=resolveLabel(item.key);
      html+=`<li><strong>${l.cat}</strong><ul>`;
      item.subs.forEach(sub=>{
        const sl=resolveLabel(item.key,sub.key);
        html+=`<li>${sl.sub}: ${sub.qty}</li>`;
      });
      html+="</ul></li>";
    });
    html+="</ul>";

    if (state.remarks && state.remarks.trim() !== "") {
      const safeRemarks = state.remarks
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
      html += `<h3>Bemerkungen / Remarques</h3>`;
      html += `<p>${safeRemarks}</p>`;
    }

    summaryContent.innerHTML=html;
    sendInfo.textContent="";
  }

  function buildMailBody(){
    let body="";
    body += "Besteller / Demandeur: " + state.besteller + "\n";
    body += "Zug / Section: " + state.zug + "\n";
    body += "Sprache in der App / Langue dans l'application: " +
      (state.language==="fr"?"Französisch / Français":"Deutsch / Allemand") + "\n";
    body += "Bestelldatum / Date de la demande: " + formatDateTime(state.bestelldatum) + "\n";
    body += "Abholung / Retrait: " + formatDateTime(state.abholung) + "\n";
    body += "Rückgabe / Retour: " + formatDateTime(state.rueckgabe) + "\n";

    if (state.remarks && state.remarks.trim() !== "") {
      body += "\nBemerkungen / Remarques:\n" + state.remarks + "\n";
    }

    body += "\nMaterial (Deutsch):\n";
    state.items.forEach(item=>{
      const lDe = resolveLabelLang(item.key, null, "de");
      body += "- " + lDe.cat + "\n";
      item.subs.forEach(sub=>{
        const slDe = resolveLabelLang(item.key, sub.key, "de");
        body += "   • " + slDe.sub + ": " + sub.qty + "\n";
      });
    });

    body += "\n------------------------------\n\n";

    body += "Matériel (Français):\n";
    state.items.forEach(item=>{
      const lFr = resolveLabelLang(item.key, null, "fr");
      body += "- " + lFr.cat + "\n";
      item.subs.forEach(sub=>{
        const slFr = resolveLabelLang(item.key, sub.key, "fr");
        body += "   • " + slFr.sub + ": " + sub.qty + "\n";
      });
    });

    return body;
  }

  function sendOrder(){
    const lang = getLang();
    state.remarks = remarksEl.value.trim();

    const subject =
      (lang === "fr" ? "Commande de matériel " : "Materialbestellung ") +
      (state.zug ? state.zug + " – " : "") +
      (state.besteller || "");

    const bodyText = buildMailBody();

    const templateParams = {
      subject: subject,
      message: bodyText,
      besteller: state.besteller,
      zug: state.zug,
      sprache_app:
        state.language === "fr" ? "Französisch / Français" : "Deutsch / Allemand"
    };

    sendInfo.style.color = "#555";
    sendInfo.textContent =
      lang === "fr" ? "Envoi en cours…" : "Bestellung wird versendet…";

    emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
      .then(function () {
        sendInfo.style.color = "#060";
        sendInfo.textContent =
          lang === "fr"
            ? "Commande envoyée avec succès."
            : "Bestellung wurde erfolgreich versendet.";
      })
      .catch(function (error) {
        console.error("EmailJS error:", error);
        sendInfo.style.color = "#c00";
        sendInfo.textContent =
          lang === "fr"
            ? "Erreur lors de l'envoi. Veuillez réessayer ou contacter le fourrier."
            : "Fehler beim Versenden. Bitte erneut versuchen oder den Fourier kontaktieren.";
      });
  }

  // DOM-Shortcuts
  const languageEl=document.getElementById("language");
  const besteller=document.getElementById("besteller");
  const zugEl=document.getElementById("zug");
  const bestelldatumEl=document.getElementById("bestelldatum");
  const abholungEl=document.getElementById("abholung");
  const rueckgabeEl=document.getElementById("rueckgabe");
  const step1Error=document.getElementById("step1Error");
  const step2Error=document.getElementById("step2Error");
  const step2Title=document.getElementById("step2Title");
  const step2Intro=document.getElementById("step2Intro");
  const step3Title=document.getElementById("step3Title");
  const summaryContent=document.getElementById("summaryContent");
  const sendInfo=document.getElementById("sendInfo");
  const step1=document.getElementById("step1");
  const step2=document.getElementById("step2");
  const step3=document.getElementById("step3");
  const remarksEl=document.getElementById("remarks");

  window.addEventListener("load", initDates);
</script>
</body>
</html>
